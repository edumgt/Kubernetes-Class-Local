# K3s 멀티노드 설치 가이드 (UTM Shared Network 192.168.64.x, Ubuntu 22.04, Docker 없이)

> 목표: UTM VM 3대(**cp1/w1/w2**)를 **Shared Network(192.168.64.0/24)**로 묶고,
> **K3s 멀티노드 클러스터**를 설치/조인한 뒤 정상 동작까지 확인합니다.

- 날짜: 2026-01-10
- 전제: Shared Network가 구성되어 있고, VM들 간/호스트 간 **ping이 성공**해야 합니다.
  (Shared Network 구성은 별도 문서 “UTM Shared Network 네트워크 가이드” 참고)

---

## 0) 목표 IP/역할

| 노드 | 역할 | Shared Network IP |
|---|---|---|
| cp1 | k3s server(control-plane) | `192.168.64.10` |
| w1 | k3s agent(worker) | `192.168.64.11` |
| w2 | k3s agent(worker) | `192.168.64.12` |

> 실제 서브넷이 다르면 위 IP를 해당 대역으로 치환하세요.

---

## 1) UTM VM 네트워크 설정 (3대 모두)

각 VM → **Settings → Network**

- **Network Mode**: Shared Network
- (권장) Adapter 1 하나만 사용

---

## 2) Ubuntu에서 Shared Network 정적 IP 설정 (netplan)

### 2-1) 인터페이스 이름 확인

각 VM에서:
```bash
ip -br a
ip -4 route show default
```

예시:
```text
enp0s1    UP   192.168.64.20/24
default via 192.168.64.1 dev enp0s1
```

> 아래 예시는 인터페이스가 `enp0s1`인 케이스 기준입니다. 다르면 이름만 바꾸세요.

### 2-2) cp1 (192.168.64.10)

```bash
sudo tee /etc/netplan/00-installer-config.yaml >/dev/null <<'EOF'
network:
  version: 2
  ethernets:
    enp0s1:
      dhcp4: no
      addresses: [192.168.64.10/24]
      routes:
        - to: default
          via: 192.168.64.1
      nameservers:
        addresses: [1.1.1.1, 8.8.8.8]
EOF

sudo chmod 600 /etc/netplan/00-installer-config.yaml
sudo netplan apply
ip -br a
```

> `/etc/netplan/50-cloud-init.yaml`이 남아 있고 `dhcp4: true`면 DHCP가 다시 붙습니다.  
> `sudo mv /etc/netplan/50-cloud-init.yaml /etc/netplan/50-cloud-init.yaml.bak` 후 `sudo netplan apply`.

### 2-3) w1 / w2

위 파일에서 IP만 바꿉니다.

- w1: `192.168.64.11/24`
- w2: `192.168.64.12/24`

---

## 3) 통신 테스트 (여기서 성공해야 다음 진행)

### 3-1) macOS → cp1

```bash
ping -c 1 192.168.64.10
```

### 3-2) cp1 → 게이트웨이(호스트 역할)

```bash
ping -c 1 192.168.64.1
```

✅ 둘 다 성공하면 네트워크 준비 완료.

---

## 4) 호스트명(Hostname) 유니크 설정 (각 VM에서 1회)

```bash
sudo hostnamectl set-hostname cp1   # cp1에서
sudo hostnamectl set-hostname w1    # w1에서
sudo hostnamectl set-hostname w2    # w2에서
```

(선택) 바로 반영 확인:
```bash
hostname
```

---

## 5) K3s 설치

### 5-1) cp1: k3s server 설치

cp1에서:
```bash
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io |   K3S_KUBECONFIG_MODE="644" sh -s -   --node-ip 192.168.64.10   --flannel-iface enp0s1
```

> `enp0s1`는 실제 인터페이스 이름으로 바꾸세요.

설치/상태 확인:
```bash
sudo systemctl status k3s --no-pager -l
kubectl get nodes -o wide
```

### 5-2) cp1: 조인 토큰 확인

```bash
sudo cat /var/lib/rancher/k3s/server/node-token
```

> 이 토큰을 w1/w2 조인 시 `K3S_TOKEN=`에 그대로 넣습니다.

---

## 6) w1/w2: k3s agent 조인

> ⚠️ 조인은 **각 VM 콘솔/SSH**에서 실행하는 것을 권장합니다.

### 6-1) w1 조인

```bash
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io |   K3S_URL="https://192.168.64.10:6443"   K3S_TOKEN="(cp1에서 복사한 토큰)" sh -s -   --node-ip 192.168.64.11   --flannel-iface enp0s1
```

### 6-2) w2 조인

```bash
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io |   K3S_URL="https://192.168.64.10:6443"   K3S_TOKEN="(cp1에서 복사한 토큰)" sh -s -   --node-ip 192.168.64.12   --flannel-iface enp0s1
```

---

## 7) 최종 확인 (cp1)

```bash
kubectl get nodes -o wide
kubectl get pods -A
```

정상 예시(형태):
```text
NAME  STATUS  ROLES                 AGE  VERSION
cp1   Ready   control-plane,master  ...
w1    Ready   <none>                ...
w2    Ready   <none>                ...
```

---

## 8) (문제 해결) 조인/통신이 꼬일 때 체크 포인트

### 8-1) cp1 API(6443) 접근 테스트

w1/w2에서:
```bash
curl -k https://192.168.64.10:6443/ping
```
(응답이 없더라도 “연결 자체”가 되는지 판단용)

### 8-2) node-ip / flannel-iface 실수

- `--node-ip`가 Shared Network IP와 일치해야 함
- `--flannel-iface`가 Shared Network 인터페이스와 일치해야 함 (`enp0s1` 등)

### 8-3) 방화벽(UFW)

UFW가 켜져 있으면 내부 통신이 막힐 수 있습니다.
```bash
sudo ufw status
```
