# K3s 멀티노드 빠른 요약 (UTM Shared Network 192.168.64.x)

> 목표: VM 3대(cp1/w1/w2)를 Shared Network로 묶고
> K3s 멀티노드 클러스터를 설치합니다.

---

## 1) VM 네트워크 설정 (3대 모두)

UTM → VM 설정 → Network

- **Network Mode**: Shared Network
- (권장) Adapter 1 하나만 사용

---

## 2) Ubuntu Shared Network 고정 IP 설정 (netplan)

인터페이스 확인:

```bash
ip -br a
ip -4 route show default
```

예시:
```text
enp0s1    UP   192.168.64.20/24
default via 192.168.64.1 dev enp0s1
```

### cp1 (192.168.64.10)

```bash
sudo tee /etc/netplan/00-installer-config.yaml >/dev/null <<'NETPLAN'
network:
  version: 2
  ethernets:
    enp0s1:
      dhcp4: no
      addresses: [192.168.64.10/24]
      routes:
        - to: default
          via: 192.168.64.1
      nameservers:
        addresses: [1.1.1.1, 8.8.8.8]
NETPLAN

sudo chmod 600 /etc/netplan/00-installer-config.yaml
sudo netplan apply
ip -br a
```

> `/etc/netplan/50-cloud-init.yaml`이 남아 있고 `dhcp4: true`면 DHCP가 다시 붙습니다.  
> `sudo mv /etc/netplan/50-cloud-init.yaml /etc/netplan/50-cloud-init.yaml.bak` 후 `sudo netplan apply`.

### w1 / w2

`192.168.64.11`, `192.168.64.12`로 IP만 변경해 동일하게 적용합니다.

---

## 3) 통신 테스트

macOS → cp1:

```bash
ping -c 1 192.168.64.10
```

cp1 → 게이트웨이(호스트 역할):

```bash
ping -c 1 192.168.64.1
```

---

## 4) K3s 설치

### 4-1) 호스트명 설정 (각 VM에서 1회)

```bash
sudo hostnamectl set-hostname cp1   # cp1
sudo hostnamectl set-hostname w1    # w1
sudo hostnamectl set-hostname w2    # w2
```

### 4-2) cp1: 서버 설치

```bash
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io | \
  K3S_KUBECONFIG_MODE="644" sh -s - \
  --node-ip 192.168.64.10 \
  --flannel-iface enp0s1
```

토큰 확인:

```bash
sudo cat /var/lib/rancher/k3s/server/node-token
```

### 4-3) w1/w2: 워커 조인

```bash
sudo apt update && sudo apt install -y curl

curl -sfL https://get.k3s.io | \
  K3S_URL="https://192.168.64.10:6443" \
  K3S_TOKEN="(cp1에서 복사한 토큰)" sh -s - \
  --node-ip 192.168.64.11 \
  --flannel-iface enp0s1
```

w2는 `--node-ip 192.168.64.12`로 변경합니다.

---

## 5) 최종 확인 (cp1)

```bash
kubectl get nodes -o wide
kubectl get pods -A
```

---

## 참고

- `enp0s1`는 실제 인터페이스 이름으로 바꾸세요.
- macOS는 `kubectl` 관리용으로만 사용해도 충분합니다.
