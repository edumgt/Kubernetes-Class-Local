# UTM Shared Network + 정적 IP 구성 가이드 (macOS + Ubuntu, K8s 멀티노드 준비)

> 목표: macOS 호스트에서 UTM으로 VM 3대(cp1/w1/w2)를 구성하고,
> UTM Shared Network(NAT)에서 정적 IP로 통신되게 설정합니다.
> 예시는 `192.168.64.0/24`를 사용하며, 실제 서브넷은 VM에서 확인합니다.

---

## 1) UTM 설치

- 다운로드: <https://mac.getutm.app/>
- Apple Silicon이면 **ARM64 Ubuntu ISO**를 사용합니다.

---

## 2) UTM VM 네트워크 설정 (3대 모두)

각 VM → **Settings → Network**

- **Network Mode**: Shared Network
- (권장) Adapter 1 하나만 사용

> Shared Network는 VM들 간 통신과 인터넷 접근을 동시에 제공합니다.

---

## 3) VM에서 서브넷/게이트웨이/인터페이스 확인

각 VM에서:

```bash
ip -br a
ip -4 route show default
```

예시(형태):
```text
enp0s1    UP   192.168.64.20/24
default via 192.168.64.1 dev enp0s1
```

> 위 예시에서 `enp0s1`가 인터페이스 이름, `192.168.64.1`이 게이트웨이입니다.

---

## 4) Ubuntu 정적 IP 설정 (netplan)

인터페이스 이름은 위에서 확인한 값(예: `enp0s1`)로 바꿔주세요.

### cp1 (192.168.64.10)

```bash
sudo tee /etc/netplan/00-installer-config.yaml >/dev/null <<'EOF'
network:
  version: 2
  ethernets:
    enp0s1:
      dhcp4: no
      addresses: [192.168.64.10/24]
      routes:
        - to: default
          via: 192.168.64.1
      nameservers:
        addresses: [1.1.1.1, 8.8.8.8]
EOF

sudo chmod 600 /etc/netplan/00-installer-config.yaml
sudo netplan apply
ip -br a
```

> `/etc/netplan/50-cloud-init.yaml`이 남아 있고 `dhcp4: true`면 DHCP가 다시 붙습니다.  
> 이 경우 `sudo mv /etc/netplan/50-cloud-init.yaml /etc/netplan/50-cloud-init.yaml.bak` 후 `sudo netplan apply`.

### w1 (192.168.64.11), w2 (192.168.64.12)

위 파일에서 `192.168.64.10`만 각각 `192.168.64.11`, `192.168.64.12`로 바꾸면 됩니다.

---

## 5) 통신 테스트(반드시 성공해야 다음 단계가 쉬움)

### macOS → cp1

```bash
ping -c 1 192.168.64.10
```

### cp1 → 게이트웨이(호스트 역할)

```bash
ping -c 1 192.168.64.1
```

---

## 6) 다음 단계(예고): K3s 멀티노드 조인 흐름

1) cp1에 k3s server 설치  
2) cp1에서 token 확인  
3) w1/w2에서 join  
4) `kubectl get nodes`로 3대 노드 확인
